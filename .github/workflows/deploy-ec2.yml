name: CI/CD - Deploy to EC2

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    name: Build and package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: app
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests (if any)
        working-directory: app
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then pip install pytest && pytest -q || true; fi

      - name: Create app archive
        run: |
          rm -f artifact.tar.gz
          tar -czf artifact.tar.gz -C app .

      - name: Upload artifact for deploy job
        uses: actions/upload-artifact@v4
        with:
          name: app-archive
          path: artifact.tar.gz

  deploy:
    name: Deploy to EC2 (main)
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-archive

      - name: Start SSH agent and load key
        uses: webfactory/ssh-agent@v0.6.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Copy artifact to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Copying artifact to ${EC2_USER}@${EC2_HOST}:${DEPLOY_PATH} ..."
          mkdir -p /tmp/deploy
          mv app-archive/artifact.tar.gz /tmp/deploy/
          scp -o StrictHostKeyChecking=no -P ${SSH_PORT:-22} /tmp/deploy/artifact.tar.gz ${EC2_USER}@${EC2_HOST}:${DEPLOY_PATH}

      - name: Run remote deploy commands on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          SERVICE_NAME: ${{ secrets.DEPLOY_SERVICE_NAME }}
        run: |
          echo "Running remote deployment on ${EC2_HOST}..."
          ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22} ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e
            mkdir -p "${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"
            # Unpack artifact and install deps if present
            tar -xzf artifact.tar.gz -C .
            if [ -f requirements.txt ]; then python3 -m pip install --user -r requirements.txt; fi
            # If SERVICE_NAME provided, try to restart the service (e.g. demo-app)
            if [ -n "${SERVICE_NAME}" ]; then
              sudo systemctl daemon-reload || true
              sudo systemctl restart "${SERVICE_NAME}" || true
            fi
            echo "Deploy completed on '${EC2_HOST}'"
          EOF

      - name: Post-deploy status
        run: echo "Deployed to ${{ secrets.EC2_HOST }}"



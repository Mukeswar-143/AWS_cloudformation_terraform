name: Build & Deploy Docker → ECR → App Runner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build, push and deploy
    runs-on: ubuntu-latest
    environment: demo   # REQUIRED to load demo environment secrets
    env:
      IMAGE_PORT: 8080
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      APPRUNNER_SERVICE_NAME: ${{ secrets.APPRUNNER_SERVICE_NAME }}
      AWS_REGION: ${{ secrets.AWS_REGION }}   # Make region accessible inside run scripts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Determine AWS Account & ECR registry
        id: aws-info
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account=${ACCOUNT_ID}" >> $GITHUB_OUTPUT

          if [ -z "${ECR_REPOSITORY}" ]; then
            ECR_REPOSITORY="demo-app-repo-${{ github.ref_name || 'main' }}"
            echo "ECR_REPOSITORY=$ECR_REPOSITORY" >> $GITHUB_ENV
          fi

          # CORRECT REGISTRY FORMAT
          REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "registry=${REGISTRY}" >> $GITHUB_OUTPUT

      - name: Login to ECR
        run: |
          docker logout ${{ steps.aws-info.outputs.registry }} || true
          aws ecr get-login-password | docker login --username AWS --password-stdin \
          ${{ steps.aws-info.outputs.registry }}

      - name: Ensure ECR repository exists
        run: |
          REPO=${{ env.ECR_REPOSITORY }}
          if ! aws ecr describe-repositories --repository-names "$REPO" >/dev/null 2>&1; then
            echo "Creating ECR repository: $REPO"
            aws ecr create-repository --repository-name "$REPO"
          else
            echo "ECR repository $REPO already exists"
          fi

      - name: Build Docker image
        run: |
          TAG=${GITHUB_SHA::8}
          REGISTRY=${{ steps.aws-info.outputs.registry }}
          REPO=${{ env.ECR_REPOSITORY }}
          IMAGE="${REGISTRY}/${REPO}:${TAG}"

          docker build -t "${IMAGE}" -t "${REGISTRY}/${REPO}:latest" ./app

      - name: Push image to ECR
        run: |
          TAG=${GITHUB_SHA::8}
          REGISTRY=${{ steps.aws-info.outputs.registry }}
          REPO=${{ env.ECR_REPOSITORY }}
          docker push "${REGISTRY}/${REPO}:${TAG}"
          docker push "${REGISTRY}/${REPO}:latest"

      - name: Create or update App Runner service
        if: env.APPRUNNER_SERVICE_NAME != ''
        run: |
          REGISTRY=${{ steps.aws-info.outputs.registry }}
          REPO=${{ env.ECR_REPOSITORY }}
          TAG=${GITHUB_SHA::8}
          IMAGE_URI="${REGISTRY}/${REPO}:${TAG}"

          echo "Checking if App Runner service exists: $APPRUNNER_SERVICE_NAME"

          SERVICE_ARN=$(aws apprunner list-services \
            --query "ServiceSummaryList[?ServiceName=='${APPRUNNER_SERVICE_NAME}'].ServiceArn | [0]" \
            --output text || echo "")

          if [ -z "$SERVICE_ARN" ] || [ "$SERVICE_ARN" = "None" ]; then
            echo "Creating App Runner service ${APPRUNNER_SERVICE_NAME}"
            aws apprunner create-service \
              --service-name "${APPRUNNER_SERVICE_NAME}" \
              --source-configuration "ImageRepository={ImageIdentifier='${IMAGE_URI}',ImageRepositoryType='ECR',ImageConfiguration={Port='${IMAGE_PORT}'}},AuthenticationConfiguration={ConnectionArn=''},AutoDeploymentsEnabled=true"
          else
            echo "Updating App Runner service: $SERVICE_ARN"
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration "ImageRepository={ImageIdentifier='${IMAGE_URI}',ImageRepositoryType='ECR',ImageConfiguration={Port='${IMAGE_PORT}'}},AutoDeploymentsEnabled=true"
          fi
